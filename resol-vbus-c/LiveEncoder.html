<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>LiveEncoder - resol-vbus-c</title>


        <!-- Custom HTML head -->
        
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="index.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="Details.html"><strong aria-hidden="true">2.</strong> Details</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="ErrorHandling.html"><strong aria-hidden="true">2.1.</strong> Error handling</a></li><li class="chapter-item expanded "><a href="LiveEncoder.html" class="active"><strong aria-hidden="true">2.2.</strong> LiveEncoder</a></li><li class="chapter-item expanded "><a href="LiveDecoder.html"><strong aria-hidden="true">2.3.</strong> LiveDecoder</a></li><li class="chapter-item expanded "><a href="LiveTransceiver.html"><strong aria-hidden="true">2.4.</strong> LiveTransceiver</a></li><li class="chapter-item expanded "><a href="Debugging.html"><strong aria-hidden="true">2.5.</strong> Debugging</a></li></ol></li><li class="chapter-item expanded "><a href="Examples.html"><strong aria-hidden="true">3.</strong> Examples</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="MasterExample.html"><strong aria-hidden="true">3.1.</strong> Master</a></li><li class="chapter-item expanded "><a href="MinionExample.html"><strong aria-hidden="true">3.2.</strong> Minion</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">resol-vbus-c</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="liveencoder"><a class="header" href="#liveencoder">LiveEncoder</a></h1>
<p>The &quot;LiveEncoder&quot; module implements the <code>RESOLVBUS_LIVEENCODER</code> type and its associated functions, which can be used to convert VBus primitives (like e.g. packets) into their over-the-wire representation.</p>
<p>In addition to that it also supports energy management functions and timeout handling.</p>
<h2 id="initialization-and-integration"><a class="header" href="#initialization-and-integration">Initialization and integration</a></h2>
<p>Before the encoder can be used, it must be initialized by calling <code>ResolVBus_LiveEncoder_Initialize</code>:</p>
<pre><code>// ...
RESOLVBUS_LIVEENCODER Encoder = RESOLVBUS_LIVEENCODER_INITIALIZER;
uint8_t Buffer [512] = { 0 };
if (Result == RESOLVBUS_OK) {
    Result = ResolVBus_LiveEncoder_Initialize(&amp;Encoder, Buffer, sizeof (Buffer), LiveEncoderEventHandler));
}
// ...
</code></pre>
<p>The function takes four arguments: the encoder instance itself, a transmission buffer as well as its length and an event handler function.</p>
<p>The transmission buffer is used by the <code>ResolVBus_LiveEncoder_Queue...</code> functions to store the over-the-wire representation of the VBus primitives. It must be large enough to hold the largest VBus primitive that is expected to be transmitted.</p>
<p>The event handler is a function that is called whenever the encoder wants to inform its user about an event:</p>
<ul>
<li><code>RESOLVBUS_LIVEENCODEREVENTTYPE_IDLE</code>: the encoder is idle and would accept queueing VBus primitives for transmission</li>
<li><code>RESOLVBUS_LIVEENCODEREVENTTYPE_TRANSMIT</code>: the encoder wants to transmit a chunk of a VBus primitive</li>
</ul>
<p>The event handler is called from the event pump implemented in <code>ResolVBus_LiveEncoder_HandleTimer</code>. This function must be called &quot;frequently&quot; (see its documentation for details). The function takes the time that has passed since the last call as its second argument. That time is used to drive forward the internal state machine.</p>
<h2 id="the-state-machine-and-its-phases"><a class="header" href="#the-state-machine-and-its-phases">The state machine and its phases</a></h2>
<p>The encoder contains a state machine that can be in one of the following phases:</p>
<ul>
<li><code>RESOLVBUS_LIVEENCODERPHASE_IDLE</code>: nothing to do yet, can be used to queue VBus primitives for transmission, emits <code>RESOLVBUS_LIVEENCODEREVENTTYPE_IDLE</code> event</li>
<li><code>RESOLVBUS_LIVEENCODERPHASE_TRANSMITTING</code>: currently transmitting VBus data, emits <code>RESOLVBUS_LIVEENCODEREVENTTYPE_TRANSMIT</code> event</li>
<li><code>RESOLVBUS_LIVEENCODERPHASE_GAININGENERGY</code>: used to regain energy after transmitting VBus data</li>
<li><code>RESOLVBUS_LIVEENCODERPHASE_SUSPENDED</code>: suspended until manually resumed</li>
<li><code>RESOLVBUS_LIVEENCODERPHASE_SUSPENDEDWITHTIMEOUT</code>: suspended until manually resumed or timeout elapses</li>
</ul>
<h2 id="queuing-vbus-primitives-for-transmission"><a class="header" href="#queuing-vbus-primitives-for-transmission">Queuing VBus primitives for transmission</a></h2>
<p>The encoder provides several <code>ResolVBus_LiveEncoder_Queue...</code> functions to queue VBus primitives into its internal transmit buffer. On the next call to <code>ResolVBus_LiveEncoder_HandleTimer</code> the actual transmission is started.</p>
<p>Queuing VBus primitives is only allowed while the encoder is idle. If the encoder is used in a VBus master context, it is recommended to queue VBus primitives for the <code>RESOLVBUS_LIVEENCODEREVENTTYPE_IDLE</code> event handling code. If the encoder is used in a VBus minion context, it is recommended to manually resume the encoder from its <code>RESOLVBUS_LIVEENCODERPHASE_SUSPENDED</code> phase before actually queueing the response.</p>
<h2 id="energy-management"><a class="header" href="#energy-management">Energy management</a></h2>
<p>The VBus transports both information and electrical energy. Since transmitting information disrupts transporting energy, care must be taken to not transmit too much data at once. For that purpose the encoder implements a basic energy management functionality.</p>
<p>That functionality can be configured using three configuration fields:</p>
<ul>
<li><code>MaxEnergy</code>: maximum amount of energy that can be consume before a transmission must be segmented into multiple parts</li>
<li><code>EnergyLossPerByte</code>: assumed loss of energy per transmitted byte</li>
<li><code>EnergyGainPerUs</code>: assumed gain of energy per microsecond in the <code>RESOLVBUS_LIVEENCODERPHASE_GAININGENERGY</code> phase</li>
</ul>
<p>When the encoder is in its idle phase the energy level is assumed to be at its maximum capacity. When data is queued into the transmit buffer, the encoder switches into its <code>RESOLVBUS_LIVEENCODERPHASE_TRANSMITTING</code> phase. It then transmits as many bytes as possible, summing up the energy loss accordingly, but not exceeding the <code>MaxEnergy</code> value. After the bytes have been transmitted the encoder switches into the <code>RESOLVBUS_LIVEENCODERPHASE_GAININGENERGY</code> phase, waiting for the consumed energy to refill. Once the energy level is back at full capacity the encoder either continues transmitting the remaining bytes from the buffer or switches into one of the suspended or idle phases.</p>
<p>Setting <code>MaxEnergy</code> to zero disables the energy management functionality.</p>
<h2 id="suspension-and-timeout-handling"><a class="header" href="#suspension-and-timeout-handling">Suspension and timeout handling</a></h2>
<p>The VBus uses a single-master topology. Only the master is allowed to transmit at any time. Minions attached to the VBus must not transmit unless they have been requested to do so by the master. In those situations the master has to grant the minion a predefined time period to transmit its reply.</p>
<p>The encoder supports both the VBus master and VBus minion contexts.</p>
<p>In a VBus master context the user of the encoder can queue a VBus request primitive and then use <code>ResolVBus_LiveEncoder_SuspendWithTimeout</code> to request that the encoder enters a suspended state for a predefined period of time after the request was transmitted, giving the minion enough time to respond to the request.</p>
<p>In a VBus minion context the user of the encoder can immediately use <code>ResolVBus_LiveEncoder_Suspend</code> to switch the encoder into a suspended state for an indefinite period of time. Once the request has been received, the encoder can be manually resumed using <code>ResolVBus_LiveEncoder_Resume</code>, the reply can be queued for transmission and then <code>ResolVBus_LiveEncoder_Suspend</code> can be used to request entering the suspended state again after the transmission.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="ErrorHandling.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="LiveDecoder.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="ErrorHandling.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="LiveDecoder.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script type="text/javascript">
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->


    </body>
</html>
