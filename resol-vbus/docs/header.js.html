<!DOCTYPE html>

<html lang="en">
<head>
	<meta charset="utf-8">
	<title>resol-vbus Source: header.js</title>

	<!--[if lt IE 9]>
	<script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->
	<link type="text/css" rel="stylesheet" href="styles/sunlight.default.css">

	
	<link type="text/css" rel="stylesheet" href="styles/site.spacelab.css">
	
</head>

<body>
<div class="container-fluid">
	<div class="navbar navbar-fixed-top navbar-inverse">
		<div class="navbar-inner">
			<a class="brand" href="index.html">resol-vbus</a>
			<ul class="nav">
				
				<li class="dropdown">
					<a href="classes.list.html" class="dropdown-toggle" data-toggle="dropdown">Classes<b
						class="caret"></b></a>

					<ul class="dropdown-menu ">
						
						<li>
							<a href="Connection.html">Connection</a>
						</li>
						
						<li>
							<a href="ConnectionCustomizer.html">ConnectionCustomizer</a>
						</li>
						
						<li>
							<a href="Converter.html">Converter</a>
						</li>
						
						<li>
							<a href="Customizer.html">Customizer</a>
						</li>
						
						<li>
							<a href="DLxRecorder.html">DLxRecorder</a>
						</li>
						
						<li>
							<a href="Header.html">Header</a>
						</li>
						
						<li>
							<a href="HeaderSet.html">HeaderSet</a>
						</li>
						
						<li>
							<a href="I18N.html">I18N</a>
						</li>
						
						<li>
							<a href="Packet.html">Packet</a>
						</li>
						
						<li>
							<a href="Recorder.html">Recorder</a>
						</li>
						
						<li>
							<a href="Specification.html">Specification</a>
						</li>
						
						<li>
							<a href="TcpConnection.html">TcpConnection</a>
						</li>
						
						<li>
							<a href="Telegram.html">Telegram</a>
						</li>
						
						<li>
							<a href="TextConverter.html">TextConverter</a>
						</li>
						

					</ul>
				</li>
				
				<li class="dropdown">
					<a href="events.list.html" class="dropdown-toggle" data-toggle="dropdown">Events<b
						class="caret"></b></a>

					<ul class="dropdown-menu ">
						
						<li>
							<a href="HeaderSet.html#event:addHeader">addHeader</a>
						</li>
						
						<li>
							<a href="HeaderSet.html#event:removeHeader">removeHeader</a>
						</li>
						

					</ul>
				</li>
				
			</ul>
		</div>
	</div>

	<div class="row-fluid">

		
			<div class="span12">
				
				<div id="main">
					


		<h1 class="page-title">Source: header.js</h1>
    
    <section>
        <article>
            <pre class="sunlight-highlight-javascript ">/*! resol-vbus | Copyright (c) 2013-2014, Daniel Wippermann | MIT license */
'use strict';



var _ = require('lodash');
var sprintf = require('sprintf').sprintf;


var extend = require('./extend');



var optionKeys = [
    'timestamp',
    'channel',
    'destinationAddress',
    'sourceAddress',
];



var Header = extend(null, /** @lends Header# */ {

    /**
     * Timestamp of this header
     * @type {Date}
     * @default now
     */
    timestamp: null,

    /**
     * VBus channel of this header
     * @type {number}
     * @default 0
     */
    channel: 0,

    /**
     * VBus address of this header's destination
     * @type {number}
     * @default 0
     */
    destinationAddress: 0,

    /**
     * VBus address of this header's source
     * @type {number}
     * @default
     */
    sourceAddress: 0,

    /**
     * Creates a new Header instance and optionally initializes its members
     * with the given values
     *
     * @constructs
     * @param {object} [options] Initialization values for this instance's members
     * @param {Date} [options.timestamp] {@link Header#timestamp}
     * @param {number} [options.channel] {@link Header#channel}
     * @param {number} [options.destinationAddress] {@link Header#destinationAddress}
     * @param {number} [options.sourceAddress] {@link Header#sourceAddress}
     */
    constructor: function(options) {
        _.extend(this, _.pick(options, optionKeys));

        if (!this.timestamp) {
            this.timestamp = new Date();
        }
    },

    /**
     * Creates a representation of this Header instance that can be
     * transmitted over a Connection. If no buffer is given as an
     * arguments, it creates a new one that is big enough to hold
     * the representation.
     *
     * Must be implemented by sub-class.
     *
     * @abstract
     * @param {Buffer} [buffer] Buffer object to store data in
     * @param {number} [start] Start index in the buffer
     * @param {number} [end] End index in the buffer
     * @returns {Buffer} Buffer object containing the data
     */
    toLiveBuffer: function(/* buffer, start, end */) {
        throw new Error('Must be implemented by sub-class');
    },

    /**
     * Returns the protocol version of this Header instance as a 8-bit
     * number. The high nibble is used for the major version, the low
     * nibble for the minor version. For example: a header with protocol
     * version 2.0 would return `0x20`.
     *
     * Must be implemented by sub-class.
     *
     * @abstract
     * @returns {number} Protocol version
     */
    getProtocolVersion: function() {
        throw new Error('Must be implemented by sub-class');
    },

    /**
     * Returns an info number about this Header instance. It can be used
     * for sorting purposes (to distinguish Header objects that would
     * otherwise compare as equal).
     *
     * @returns {number} Info value
     */
    getInfo: function() {
        return 0;
    },

    /**
     * Returns a string identifier describing this Header instance.
     * It contains at least:
     *
     *   - channel
     *   - destination address
     *   - source address
     *   - protocol version
     *
     * Sub-classes can extend that information. The structure of this
     * identifier is implementation specific, do not rely on it!
     *
     * @returns {string} Identifier
     */
    getId: function() {
        return sprintf('%02X_%04X_%04X_%02X', this.channel, this.destinationAddress, this.sourceAddress, this.getProtocolVersion());
    },

    /**
     * Compares this Header instance to another one.
     *
     * Sub-classes can extend the comparison to include specific
     * information.
     *
     * @param {Header} that Another Header instance to compare to.
     * @returns {number} Returns a number
     *
     *   - less than 0 if `this &lt; that`
     *   - greater than 0 if `this > that`
     *   - equal to to if `this == that`
     */
    compareTo: function(that) {
        var result = this.channel - that.channel;
        if (result === 0) {
            result = this.destinationAddress - that.destinationAddress;
        }
        if (result === 0) {
            result = this.sourceAddress - that.sourceAddress;
        }
        if (result === 0) {
            result = this.getProtocolVersion() - that.getProtocolVersion();
        }
        return result;
    },

}, /** @lends Header */ {

    /**
     * Creates a Header instance from a representation that was
     * received over a Connection.
     *
     * Must be implemented by sub-class.
     *
     * @abstract
     * @param {Buffer} buffer Buffer that contains the representation
     * @param {number} start Start index in the buffer
     * @param {number} end End index in the buffer
     * @returns {Header} Header instance created from the representation
     */
    fromLiveBuffer: function(/* buffer, start, end */) {
        throw new Error('Must be implemented by sub-class');
    },

    /**
     * Calculates the VBus checksum (according to version x.0 specification)
     * over a part of a Buffer instance.
     *
     * @param {Buffer} buffer Buffer to calc checksum for
     * @param {number} start Start index in the buffer
     * @param {number} end End index in the buffer
     * @returns {number} Calculated checksum
     */
    calcChecksumV0: function(buffer, start, end) {
        var checksum = 0;
        for (var index = start; index &lt; end; index++) {
            checksum = (checksum + buffer [index]) &amp; 0x7F;
        }
        checksum = (0x7F - checksum);
        return checksum;
    },

    /**
     * Calculates the VBus checksum (according to version x.0 specification)
     * over a part of a Buffer instance and compares it the checksum byte
     * stored at the `end` position.
     *
     * @param {Buffer} buffer Buffer to calc and compare checksum for
     * @param {number} start Start index in the buffer
     * @param {number} end End index in the buffer
     * @returns {boolean} Result whether calculated and stored checksum match
     */
    calcAndCompareChecksumV0: function(buffer, start, end) {
        var checksum = this.calcChecksumV0(buffer, start, end);
        return (buffer [end] === checksum);
    },

    /**
     * Calculates the VBus checksum (according to version x.0 specification)
     * over a part of the Buffer instance and stores it at the `end` position.
     *
     * @param {Buffer} buffer Buffer to calc and store checksum for
     * @param {number} start Start index in the buffer
     * @param {number} end End index in the buffer
     * @returns {number} Calculated checksum
     */
    calcAndSetChecksumV0: function(buffer, start, end) {
        var checksum = this.calcChecksumV0(buffer, start, end);
        buffer [end] = checksum;
        return checksum;
    },

    /**
     * Copies a part of the source Buffer instance to the destination Buffer
     * instance, injecting the MSBs stored in the septett byte during the process.
     *
     * @param {Buffer} srcBuffer Buffer to copy from
     * @param {number} srcStart Start index in the source buffer
     * @param {number} srcEnd End index in the source buffer
     * @param {Buffer} dstBuffer Buffer to copy to
     * @param {number} dstStart Start index in the destination buffer
     */
    injectSeptett: function(srcBuffer, srcStart, srcEnd, dstBuffer, dstStart) {
        var srcIndex = srcStart, dstIndex = dstStart, mask = 1, septett = srcBuffer [srcEnd];
        while (srcIndex &lt; srcEnd) {
            var b = srcBuffer [srcIndex];
            if (septett &amp; mask) {
                b |= 0x80;
            }
            dstBuffer [dstIndex] = b;

            srcIndex++;
            dstIndex++;
            mask = mask &lt;&lt; 1;
        }
    },

    /**
     * Copies a part of the source Buffer instance to the destination Buffer
     * instance, extracting the MSBs during the process and storing the septett
     * byte to the destination buffer's end position.
     *
     * @param {Buffer} srcBuffer Buffer to copy from
     * @param {number} srcStart Start index in the source buffer
     * @param {number} srcEnd End index in the source buffer
     * @param {Buffer} dstBuffer Buffer to copy to
     * @param {number} dstStart Start index in the destination buffer
     */
    extractSeptett: function(srcBuffer, srcStart, srcEnd, dstBuffer, dstStart) {
        var srcIndex = srcStart, dstIndex = dstStart, mask = 1, septett = 0;
        while (srcIndex &lt; srcEnd) {
            var b = srcBuffer [srcIndex];
            if (b &amp; 0x80) {
                b &amp;= 0x7F;
                septett |= mask;
            }
            dstBuffer [dstIndex] = b;

            srcIndex++;
            dstIndex++;
            mask = mask &lt;&lt; 1;
        }

        dstBuffer [dstIndex] = septett;
    }

});



module.exports = Header;
</pre>
        </article>
    </section>





				</div>

				<div class="clearfix"></div>
				<footer>
					
					
		<span class="copyright">
		resol-vbus | Copyright (c) 2013-2014, Daniel Wippermann
		</span>
					<br />
					
		<span class="jsdoc-message">
		Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.3.0-alpha4</a>
		on Fri Feb 14 2014 20:37:40 GMT+0100 (CET) using the <a href="https://github.com/terryweiss/docstrap">DocStrap template</a>.
		</span>
				</footer>
			</div>

			
			<br clear="both">
		</div>

	</div>
	<script src="scripts/sunlight.js"></script>
	<script src="scripts/sunlight.javascript.js"></script>
	<script src="scripts/sunlight-plugin.doclinks.js"></script>
	<script src="scripts/sunlight-plugin.linenumbers.js"></script>
	<script src="scripts/sunlight-plugin.menu.js"></script>
	<script src="scripts/jquery.min.js"></script>
	<script src="scripts/jquery.scrollTo.js"></script>
	<script src="scripts/jquery.localScroll.js"></script>
	<script src="scripts/bootstrap-dropdown.js"></script>
	<script src="scripts/toc.js"></script>


	<script>  Sunlight.highlightAll({lineNumbers:false,  showMenu: true, enableDoclinks :true}); </script>

	<script>
		$( function () {
			$( "#toc" ).toc( {
				selectors   : "h1,h2,h3,h4",
				showAndHide : false,
				scrollTo    : 60
			} );
			$( "#toc>ul" ).addClass( "nav nav-pills nav-stacked" );
			$( "#main span[id^='toc']" ).addClass( "toc-shim" );

		} );
	</script>

	

</body>
</html>
