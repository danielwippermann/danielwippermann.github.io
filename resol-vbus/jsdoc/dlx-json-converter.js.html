<!DOCTYPE html>

<html lang="en">
<head>
	<meta charset="utf-8">
	<title>resol-vbus Source: dlx-json-converter.js</title>

	<!--[if lt IE 9]>
	<script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->
	<link type="text/css" rel="stylesheet" href="styles/sunlight.default.css">

	
	<link type="text/css" rel="stylesheet" href="styles/site.spacelab.css">
	
</head>

<body>
<div class="container-fluid">
	<div class="navbar navbar-fixed-top navbar-inverse">
		<div class="navbar-inner">
			<a class="brand" href="index.html">resol-vbus</a>
			<ul class="nav">
				
				<li class="dropdown">
					<a href="classes.list.html" class="dropdown-toggle" data-toggle="dropdown">Classes<b
						class="caret"></b></a>

					<ul class="dropdown-menu ">
						
						<li>
							<a href="Connection.html">Connection</a>
						</li>
						
						<li>
							<a href="ConnectionCustomizer.html">ConnectionCustomizer</a>
						</li>
						
						<li>
							<a href="Converter.html">Converter</a>
						</li>
						
						<li>
							<a href="Customizer.html">Customizer</a>
						</li>
						
						<li>
							<a href="Datagram.html">Datagram</a>
						</li>
						
						<li>
							<a href="DLxJsonConverter.html">DLxJsonConverter</a>
						</li>
						
						<li>
							<a href="DLxRecorder.html">DLxRecorder</a>
						</li>
						
						<li>
							<a href="Header.html">Header</a>
						</li>
						
						<li>
							<a href="HeaderSet.html">HeaderSet</a>
						</li>
						
						<li>
							<a href="HeaderSetConsolidator.html">HeaderSetConsolidator</a>
						</li>
						
						<li>
							<a href="I18N.html">I18N</a>
						</li>
						
						<li>
							<a href="Packet.html">Packet</a>
						</li>
						
						<li>
							<a href="Recorder.html">Recorder</a>
						</li>
						
						<li>
							<a href="SerialConnection.html">SerialConnection</a>
						</li>
						
						<li>
							<a href="SerialDataSource.html">SerialDataSource</a>
						</li>
						
						<li>
							<a href="Specification.html">Specification</a>
						</li>
						
						<li>
							<a href="TcpConnection.html">TcpConnection</a>
						</li>
						
						<li>
							<a href="TcpConnectionEndpoint.html">TcpConnectionEndpoint</a>
						</li>
						
						<li>
							<a href="TcpDataSource.html">TcpDataSource</a>
						</li>
						
						<li>
							<a href="TcpDataSourceProvider.html">TcpDataSourceProvider</a>
						</li>
						
						<li>
							<a href="Telegram.html">Telegram</a>
						</li>
						
						<li>
							<a href="TextConverter.html">TextConverter</a>
						</li>
						
						<li>
							<a href="VBusRecordingConverter.html">VBusRecordingConverter</a>
						</li>
						

					</ul>
				</li>
				
				<li class="dropdown">
					<a href="events.list.html" class="dropdown-toggle" data-toggle="dropdown">Events<b
						class="caret"></b></a>

					<ul class="dropdown-menu ">
						
						<li>
							<a href="HeaderSet.html#event:addHeader">addHeader</a>
						</li>
						
						<li>
							<a href="HeaderSet.html#event:removeHeader">removeHeader</a>
						</li>
						
						<li>
							<a href="HeaderSetConsolidator.html#event:addHeader">addHeader</a>
						</li>
						
						<li>
							<a href="HeaderSetConsolidator.html#event:removeHeader">removeHeader</a>
						</li>
						

					</ul>
				</li>
				
				<li class="dropdown">
					<a href="global.html" class="dropdown-toggle" data-toggle="dropdown">Global<b
						class="caret"></b></a>

					<ul class="dropdown-menu ">
						
						<li>
							<a href="global.html#extend">extend</a>
						</li>
						

					</ul>
				</li>
				
			</ul>
		</div>
	</div>

	<div class="row-fluid">

		
			<div class="span12">
				
				<div id="main">
					


		<h1 class="page-title">Source: dlx-json-converter.js</h1>
    
    <section>
        <article>
            <pre class="sunlight-highlight-javascript ">/*! resol-vbus | Copyright (c) 2013-2014, Daniel Wippermann | MIT license */
'use strict';



var _ = require('lodash');
var moment = require('moment');
var sprintf = require('sprintf').sprintf;


var HeaderSet = require('./header-set');
var Specification = require('./specification');

var Converter = require('./converter');



var optionKeys = [
    'specification',
];



var DLxJsonConverter = Converter.extend(/** @lends DLxJsonConverter# */ {

    /**
     * Reference to the Specification instance that is used for the binary -> text conversion.
     * @type {Specification}
     */
    specification: null,

    allHeaderSet: null,

    emittedStart: false,

    stats: null,

    /**
     * Creates a new DLxJsonConverter instance and optionally initializes its members with the given values.
     *
     * @constructs
     * @augments Converter
     * @param {object} options Initialization values
     * @param {object} options.specification See {@link DLxJsonConverter#specification}
     *
     * @classdesc
     * The DLxJsonConverter class takes HeaderSet instances, converts them into JSON
     * representation and then publishes that on the readable stream side
     * of itself. The format of the JSON data is similar to the one that is generated
     * by the Dataloggers DL2 and DL3.
     *
     * It does not support parsing JSON content back into HeaderSet instances (the
     * writable stream side).
     */
    constructor: function(options) {
        var _this = this;

        Converter.call(this, options);

        _.extend(this, _.pick(options, optionKeys));

        if (!this.specification) {
            this.specification = new Specification({
                language: options &amp;&amp; options.language || 'en'
            });
        }

        this.allHeaderSet = new HeaderSet();

        this.reset();
    },

    reset: function() {
        this.allHeaderSet.removeAllHeaders();

        this.emittedStart = false;

        this.stats = {
            headerSetCount: 0,
            minTimestamp: null,
            maxTimestamp: null,
        };
    },

    finish: function() {
        this._emitEnd();

        return Converter.prototype.finish.apply(this, arguments);
    },

    convertHeaderSet: function(headerSet) {
        var spec = this.specification;

        var i18n = spec.i18n;

        var headers = headerSet.getHeaders();

        var packetFields = spec.getPacketFieldsForHeaders(headers);

        var now = i18n.moment(headerSet.timestamp);

        this.allHeaderSet.addHeaders(headers);
        var allHeaders = this.allHeaderSet.getHeaders();

        var packetInfoList = _.map(allHeaders, function(header, headerIndex) {
            return {
                header: header,
                headerIndex: headerIndex,
                packetFields: [],
            };
        });

        _.forEach(packetFields, function(packetField) {
            var headerIndex = allHeaders.indexOf(packetField.packet);
            var packetInfo = packetInfoList [headerIndex];
            packetInfo.packetFields.push(packetField);
        });

        var noneUnit = spec.getUnitById('None');
        var numberType = spec.getTypeById('Number');

        var packetData = _.reduce(packetInfoList, function(memo, packetInfo) {
            if (packetInfo.packetFields.length >= 0) {
                var fieldData = _.map(packetInfo.packetFields, function(packetField, packetFieldIndex) {
                    var rawValue = packetField.rawValue;
                    var precision = packetField.packetFieldSpec.type.precision;
                    var numberValue = spec.formatTextValueFromRawValueInternal(rawValue, noneUnit, numberType, precision, noneUnit);
                    rawValue = + numberValue;

                    return {
                        field_index: packetFieldIndex,
                        raw_value: rawValue,
                        value: packetField.formatTextValue('None'),
                    };
                });

                memo.push({
                    header_index: packetInfo.headerIndex,
                    timestamp: packetInfo.header.timestamp / 1000.0,
                    field_values: fieldData,
                });
            }

            return memo;
        }, []);

        var timestamp = now.valueOf();

        var headerSetData = {
            timestamp: timestamp / 1000.0,
            packets: packetData,
        };

        this._emitStart();

        var content = [
            (this.stats.headerSetCount > 0) ? ',' : '',
            JSON.stringify(headerSetData),
        ].join('');

        this.push(content);

        this.stats.headerSetCount++;

        if ((this.stats.minTimestamp === null) || (this.stats.minTimestamp > timestamp)) {
            this.stats.minTimestamp = timestamp;
        }
        if ((this.stats.maxTimestamp === null) || (this.stats.maxTimestamp &lt; timestamp)) {
            this.stats.maxTimestamp = timestamp;
        }
    },

    _emitStart: function() {
        if (!this.emittedStart) {
            this.emittedStart = true;

            this.push('{"headersets":[');
        }
    },

    _emitEnd: function() {
        var spec = this.specification;

        var allHeaders = this.allHeaderSet.getHeaders();

        var allPacketFields = spec.getPacketFieldsForHeaders(allHeaders);

        var packetInfoList = _.map(allHeaders, function(header, headerIndex) {
            return {
                header: header,
                headerIndex: headerIndex,
                packetSpec: spec.getPacketSpecification(header),
                packetFields: [],
            };
        });

        _.forEach(allPacketFields, function(packetField) {
            var headerIndex = allHeaders.indexOf(packetField.packet);
            var packetInfo = packetInfoList [headerIndex];
            packetInfo.packetFields.push(packetField);
        });

        var headersData = _.reduce(packetInfoList, function(memo, packetInfo, packetInfoIndex) {
            if (packetInfo.packetFields.length >= 0) {
                var fieldsData = _.map(packetInfo.packetFields, function(packetField, packetFieldIndex) {
                    return {
                        id: packetField.packetFieldSpec.fieldId,
                        filteredId: packetField.packetFieldSpec.filteredPacketFieldId,
                        name: packetField.name,
                        unit: packetField.packetFieldSpec.type.unit.unitText,
                        unit_code: packetField.packetFieldSpec.type.unit.unitCode,
                    };
                });

                var md;

                var packetSpec = packetInfo.packetSpec;
                var id = packetSpec.packetId;
                if ((md = /^(.._...._....)_10(_....)$/.exec(id)) !== null) {
                    id = md [1] + md [2];
                }

                var description = packetSpec.fullName;
                if ((md = /^(VBus )#([0-9]+:.*)$/.exec(description)) !== null) {
                    description = md[1] + md [2];
                } else {
                    description = 'VBus 0: ' + description;
                }

                memo.push({
                    id: id,
                    description: description,
                    channel: packetSpec.channel,
                    destination_address: packetSpec.destinationAddress,
                    source_address: packetSpec.sourceAddress,
                    protocol_version: packetSpec.protocolVersion,
                    command: packetSpec.command,
                    info: packetSpec.info,
                    destination_name: packetSpec.destinationDevice.name,
                    source_name: packetSpec.sourceDevice.name,
                    fields: fieldsData,
                });
            }

            return memo;
        }, []);

        var statsData = {
            headerset_count: this.stats.headerSetCount,
            min_timestamp : this.stats.minTimestamp / 1000.0,
            max_timestamp: this.stats.maxTimestamp / 1000.0,
        };

        this._emitStart();

        var content = [
            '],"headerset_stats":',
            JSON.stringify(statsData),
            ',"headers":',
            JSON.stringify(headersData),
            ',"language":"',
            spec.i18n.language,
            '"}'
        ].join('');

        this.push(content);

        this.push(null);
    },

    _read: function() {
        // nop
    },

});



module.exports = DLxJsonConverter;
</pre>
        </article>
    </section>





				</div>

				<div class="clearfix"></div>
				<footer>
					
					
		<span class="copyright">
		resol-vbus | Copyright (c) 2013-2014, Daniel Wippermann
		</span>
					<br />
					
		<span class="jsdoc-message">
		Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.3.0-alpha5</a>
		on Sun Sep 28 2014 07:28:46 GMT+0200 (CEST) using the <a href="https://github.com/terryweiss/docstrap">DocStrap template</a>.
		</span>
				</footer>
			</div>

			
			<br clear="both">
		</div>

	</div>
	<script src="scripts/sunlight.js"></script>
	<script src="scripts/sunlight.javascript.js"></script>
	<script src="scripts/sunlight-plugin.doclinks.js"></script>
	<script src="scripts/sunlight-plugin.linenumbers.js"></script>
	<script src="scripts/sunlight-plugin.menu.js"></script>
	<script src="scripts/jquery.min.js"></script>
	<script src="scripts/jquery.scrollTo.js"></script>
	<script src="scripts/jquery.localScroll.js"></script>
	<script src="scripts/bootstrap-dropdown.js"></script>
	<script src="scripts/toc.js"></script>


	<script>  Sunlight.highlightAll({lineNumbers:false,  showMenu: true, enableDoclinks :true}); </script>

	<script>
		$( function () {
			$( "#toc" ).toc( {
				selectors   : "h1,h2,h3,h4",
				showAndHide : false,
				scrollTo    : 60
			} );
			$( "#toc>ul" ).addClass( "nav nav-pills nav-stacked" );
			$( "#main span[id^='toc']" ).addClass( "toc-shim" );

		} );
	</script>

	

</body>
</html>
